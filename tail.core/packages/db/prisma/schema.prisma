generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Source {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  kind      String
  config    Json     @default(dbgenerated("'{}'::jsonb"))
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  syncRuns   SyncRun[]
  rawEvents  RawEvent[]
  rawUploads RawUpload[]

  @@index([kind], map: "idx_sources_kind")
  @@map("sources")
}

model SyncRun {
  id         String        @id @default(uuid()) @db.Uuid
  sourceId   String        @map("source_id") @db.Uuid
  status     String
  startedAt  DateTime?     @map("started_at") @db.Timestamptz(6)
  finishedAt DateTime?     @map("finished_at") @db.Timestamptz(6)
  stats      Json          @default(dbgenerated("'{}'::jsonb"))
  error      Json?
  createdAt  DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)

  source     Source      @relation(fields: [sourceId], references: [id])
  rawEvents  RawEvent[]
  rawUploads RawUpload[]

  @@index([sourceId, createdAt], map: "idx_sync_runs_source")
  @@index([status], map: "idx_sync_runs_status")
  @@map("sync_runs")
}

model RawEvent {
  id               String      @id @default(uuid()) @db.Uuid
  sourceId         String      @map("source_id") @db.Uuid
  syncRunId        String      @map("sync_run_id") @db.Uuid
  uploadId         String?     @map("upload_id") @db.Uuid
  rawBlobUri       String      @map("raw_blob_uri")
  rawMimeType      String      @map("raw_mime_type")
  rawRecordLocator String?     @map("raw_record_locator")
  schemaVersion    Int         @default(1) @map("schema_version")
  payload          Json
  externalId       String?     @map("external_id")
  contentHash      String      @map("content_hash")
  parseStatus      String      @default("pending") @map("parse_status")
  parseError       Json?       @map("parse_error")
  occurredAt       DateTime?   @map("occurred_at") @db.Timestamptz(6)
  ingestedAt       DateTime    @default(now()) @map("ingested_at") @db.Timestamptz(6)

  source  Source  @relation(fields: [sourceId], references: [id])
  syncRun SyncRun @relation(fields: [syncRunId], references: [id])

  @@index([syncRunId], map: "idx_raw_events_run")
  @@index([sourceId, ingestedAt], map: "idx_raw_events_source")
  @@index([parseStatus], map: "idx_raw_events_parse_status")
  @@unique([sourceId, contentHash], map: "uq_raw_events_dedupe")
  @@map("raw_events")
}

model RawUpload {
  id            String   @id @default(uuid()) @db.Uuid
  sourceId      String   @map("source_id") @db.Uuid
  syncRunId     String   @map("sync_run_id") @db.Uuid
  sourceSystem  String   @map("source_system")
  filename      String
  contentSha256 String   @map("content_sha256")
  rawBlobUri    String   @map("raw_blob_uri")
  rawMimeType   String   @map("raw_mime_type")
  uploadedAt    DateTime @default(now()) @map("uploaded_at") @db.Timestamptz(6)

  source  Source   @relation(fields: [sourceId], references: [id])
  syncRun SyncRun  @relation(fields: [syncRunId], references: [id])
  rawRows RawRow[]

  @@index([sourceId, uploadedAt], map: "idx_raw_uploads_source_uploaded")
  @@index([sourceSystem], map: "idx_raw_uploads_source_system")
  @@index([syncRunId], map: "idx_raw_uploads_sync_run")
  @@index([contentSha256], map: "idx_raw_uploads_content_sha")
  @@map("raw_uploads")
}

model RawRow {
  id           String   @id @default(uuid()) @db.Uuid
  uploadId     String   @map("upload_id") @db.Uuid
  sourceSystem String   @map("source_system")
  rowIndex     Int      @map("row_index")
  rawJson      Json     @map("raw_json")
  rowSha256    String   @map("row_sha256")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  upload                 RawUpload                @relation(fields: [uploadId], references: [id])
  normalizedTransactions NormalizedTransaction[]

  @@unique([sourceSystem, rowSha256], map: "uq_raw_rows_source_system_row_sha256")
  @@index([sourceSystem, rowSha256], map: "idx_raw_rows_source_system_row_sha256")
  @@index([uploadId, rowIndex], map: "idx_raw_rows_upload_row_index")
  @@map("raw_rows")
}

model NormalizedTransaction {
  id                   String    @id @default(uuid()) @db.Uuid
  sourceSystem         String    @map("source_system")
  rowSha256            String    @map("row_sha256")
  occurredAt           DateTime? @map("occurred_at") @db.Timestamptz(6)
  amount               Decimal   @db.Decimal(18, 4)
  currency             String
  description          String
  merchant             String?
  accountId            String?   @map("account_id")
  category             String?
  normalizationVersion String    @default("v1") @map("normalization_version")
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  rawRow RawRow @relation(fields: [sourceSystem, rowSha256], references: [sourceSystem, rowSha256])

  @@unique([sourceSystem, rowSha256, normalizationVersion], map: "uq_normalized_transactions_source_row_version")
  @@index([sourceSystem, occurredAt], map: "idx_normalized_transactions_source_occurred_at")
  @@index([occurredAt], map: "idx_normalized_transactions_occurred_at")
  @@map("normalized_transactions")
}
