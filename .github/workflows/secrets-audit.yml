name: Secrets Audit

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        type: choice
        options:
          - dev
          - stage
          - prod

jobs:
  validate:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER }}
      MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
      STORAGE_BUCKET: ${{ secrets.STORAGE_BUCKET }}
      SENTRY_DSN_WEB: ${{ secrets.SENTRY_DSN_WEB }}
      SENTRY_DSN_API: ${{ secrets.SENTRY_DSN_API }}
      SENTRY_DSN_WORKER: ${{ secrets.SENTRY_DSN_WORKER }}
    steps:
      - name: Validate required secrets
        run: |
          required=(
            POSTGRES_USER
            POSTGRES_PASSWORD
            POSTGRES_DB
            MINIO_ROOT_USER
            MINIO_ROOT_PASSWORD
            STORAGE_BUCKET
            SENTRY_DSN_WEB
            SENTRY_DSN_API
            SENTRY_DSN_WORKER
          )
          for key in "${required[@]}"; do
            if [ -z "${!key}" ]; then
              echo "::error::Missing secret: ${key}"
              exit 1
            fi
          done
